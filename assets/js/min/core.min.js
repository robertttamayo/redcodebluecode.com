/*RedCodeBlueCode*/
var postid,data,WELCOME=1,EDITOR=2,iconLeftJustify='<i class="fa fa-align-left" aria-hidden="true"></i>',iconCenterJustify='<i class="fa fa-align-center" aria-hidden="true"></i>',iconRightJustify='<i class="fa fa-align-right" aria-hidden="true"></i>',iconRemove='<i class="fa fa-trash" aria-hidden="true"></i>',iconClose='<i class="fa fa-window-close-o" aria-hidden="true"></i>',ChangeCatcher=function(t){var e=!1,a=window,o=this;t(document).on("focus click",".change-watch",function(){console.log("focus or click on .change-watch element"),o._unsavedChanges=!0,n()}),t(document).on("click",".change-reset",function(){console.log("click on .change-reset element"),o._unsavedChanges=!1,i()});var n=function(){console.log("Unsaved changes"),a.onbeforeunload=function(){return"There are unsaved changes. Are you sure you want to leave?"}},i=function(){console.log("Resetting changes. No unsaved changes"),a.onbeforeunload=null};return{get unsavedChanges(){return e},set unsavedChanges(t){"boolean"==typeof t?1==(e=t)?n():i():console.error("invalid parameter passed. boolean expected, received "+typeof t)},reset:function(){e=!1}}},changeCatcher=new ChangeCatcher(jQuery),BobBlog=function(){return{get state(){return 0}}};function catPopCallbacks(){$(".create-tag").on("click",function(){console.log("event listener fired"),saveCat()}),$(".tag-name").on("click",function(){$(this).hasClass("active-tag")?removeCatFromPost($(this),$("#postid-hidden").text()):addCatToPost($(this),$("#postid-hidden").text())}),$(".dim, #close-tag-pop").on("click",function(){$(".tag-pop-wrap").fadeOut("medium",function(){$(this).remove()})})}function tagPopCallbacks(){$(".create-tag").on("click",function(){saveTag()}),$(".tag-name").on("click",function(){$(this).hasClass("active-tag")?removeTagFromPost($(this),$("#postid-hidden").text()):addTagToPost($(this),$("#postid-hidden").text())}),$(".dim, #close-tag-pop").on("click",function(){$(".tags-pop-wrap").fadeOut("medium",function(){$(this).remove()})})}function imagePopCallbacks(){$("body").addClass("dim-active"),$("#featured-image-form").on("submit",function(t){console.log("featured image form submitted"),t.preventDefault();var e=new FormData(document.getElementById("featured-image-form"));e.append("action",actionUploadFeaturedImage),e.append("postid",getPostId()),uploadFeaturedImage(e)}),$(".dim, #featured-img-dialog-close").on("click",function(){console.log("closing featured img dialog, #featured-img-dialog-close clicked"),$(".featured-image-pop-wrap").fadeOut("medium",function(){$(this).remove()}),$("body").removeClass("dim-active")})}function mainContainerCallbacks(){$(".dim, #message-close").on("click",function(){$(".dim:not([data*=tags])").hide(),$("#message").fadeOut(),$("body").removeClass("dim-active")}),$(".post-edit").on("click",function(){var t=$(this).data("postid");load("start"),$("#main-container").html("").load(homeUrl+"src/editor.php?postid="+t,function(){editContainerCallbacks(),load("stop")})})}function editContainerCallbacks(){$(".save-post").on("click",function(){console.log("Attempting to save post"),validatePost()&&savePost(data={draft:!1})}),$(".save-draft").on("click",function(){console.log("Attempting to save post as draft"),validatePost()&&savePost(data={draft:!0})}),$(".unpublish-post").on("click",function(){console.log("Attempting to unpublish post");var t=getPostId();updateDraftStatus(data={draft:!0,postid:t})}),$(".manage-tags").on("click",function(){var t=$("#postid-hidden").text(),e=document.createElement("div"),a=homeUrl+"src/tags.php?postid="+t;console.log(a),e=$(e),$(e).load(a,function(){$("body").append($(e)),$(".dim").show().data("lock","tags"),tagPopCallbacks()})}),$(".manage-cats").on("click",function(){var t=$("#postid-hidden").text(),e=document.createElement("div"),a=homeUrl+"src/categories.php?postid="+t;console.log(a),e=$(e),$(e).load(a,function(){$("body").append($(e)),$(".dim").show().data("lock","tags"),catPopCallbacks()})}),$("#post-title").on("keyup",function(t){var e=$(this).val();e=formatPermalink(e),$("#post-permalink-input").val(e)}),$("#post-permalink-input").on("keyup",function(t){var e=$(this).val();e=formatPermalink(e),$(this).val(e)}),$(".permalink-change").on("click",function(){if($(this).parent().toggleClass("disabled"),$(this).parent().hasClass("disabled")){console.log("Attempting to update permalink");var t=$(this).parent().find("input").val();t=formatPermalink(t);var e=getPostId();updatePermalink(data={permalink:t,postid:e})}}),$(".feature-image-tool").on("click",function(){var t=$("#postid-hidden").text(),e=document.createElement("div"),a=homeUrl+"src/featuredimage.php?postid="+t;console.log(a),e=$(e),$(e).load(a,function(){$("body").append(e),$("body").addClass("dim-active"),imagePopCallbacks()})}),initEditor(),initImages(),imgEditorCallbacks()}function addTagToPost(t,e){t.toggleClass("active-tag");var a=t.data("tagid");console.log("adding tag "+t.data("tagid")+" to post "+e),$.post(window.location.href,{async:!0,action:actionAddTagToPost,tagid:a,postid:e,async:!0},function(t){console.log(t)})}function removeTagFromPost(t,e){t.toggleClass("active-tag");var a=t.data("tagid");console.log("removing tag "+t.data("tagid")+" from post "+e),$.post(window.location.href,{async:!0,action:actionRemoveTagFromPost,tagid:a,postid:e},function(t){console.log(t)})}function addCatToPost(t,e){$(".tag-name").removeClass("active-tag"),t.addClass("active-tag");var a=t.data("catid");console.log("adding tag "+t.data("catid")+" to post "+e),$.post(window.location.href,{async:!0,action:actionAddCatToPost,catid:a,postid:e},function(t){console.log(t)})}function removeCatFromPost(t,e){$(".tag-name").removeClass("active-tag");var a=t.data("catid");console.log("removing tag "+t.data("catid")+" from post "+e),$.post(window.location.href,{async:!0,action:actionRemoveCatFromPost,catid:a,postid:e},function(t){console.log(t)})}function saveTag(){var t=$("#tag-create-input").val(),e=$("#postid-hidden").text();console.log(t),$.post(window.location.href,{async:!0,action:actionSaveTag,name:t,postid:e},function(t){console.log("callback"),t=JSON.parse(t),console.log(t);var e=new CustomEvent("tag_saved",{detail:t});document.dispatchEvent(e),console.log("after dispatching event")})}function saveCat(){console.log("event function fired");var t=$("#tag-create-input").val(),e=$("#postid-hidden").text();console.log(t),$.post(window.location.href,{async:!0,action:actionSaveCat,name:t,postid:e},function(t){console.log("callback"),t=JSON.parse(t),console.log(t);var e=new CustomEvent("cat_saved",{detail:t});document.dispatchEvent(e),console.log("after dispatching event")})}function savePost(t){var e=$("#content").html(),a=$("#post-title").val(),o=t.draft,n=$("#postid-hidden").text(),i="1"===$("#is-draft-hidden").text(),c=$("#post-permalink-input").val();console.log("postid: "+n),console.log("wasDraft: "+i),$.post("#",{action:actionSavePost,name:a,file:e,draft:o,wasdraft:i,postid:n,permalink:c},function(t){console.log(t),t=JSON.parse(t),console.log(t);var e="true"==t.draft?1:0;$("#postid-hidden").text(t.postid),$("#is-draft-hidden").text(e);var a=new Event("post_saved");document.dispatchEvent(a)})}function updatePermalink(t){var e=t.permalink,a=t.postid;$.post(window.location.href,{async:!0,action:actionPostPermalink,permalink:e,postid:a},function(t){console.log(t),t=JSON.parse(t);var e=new CustomEvent("permalink_changed",{detail:t});document.dispatchEvent(e)})}function updateDraftStatus(t){var e=t.draft;console.log(t.draft);var a=t.postid;$.post(window.location.href,{async:!0,action:actionPostDraftStatus,draft:e,postid:a},function(t){console.log(t);var e="true"==(t=JSON.parse(t)).draft?1:0;$("#postid-hidden").text(t.postid),$("#is-draft-hidden").text(e);var a=new CustomEvent("draft_status_changed",{detail:t});document.dispatchEvent(a)})}function uploadImage(t){actionUploadImage;$.ajax({url:window.location.href,type:"POST",processData:!1,contentType:!1,data:t}).done(function(t){console.log(t);var e=JSON.parse(t);if(console.log(e),e.success){var a=new CustomEvent("image_uploaded",{detail:e});document.dispatchEvent(a)}else alert(e.message)})}function uploadFeaturedImage(t){var e={action:actionUploadFeaturedImage,imgdata:t};console.log(e),$.ajax({url:window.location.href,type:"POST",processData:!1,contentType:!1,data:t}).done(function(t){console.log(t);var e=JSON.parse(t);if(console.log(e),e.success){var a=new CustomEvent("featured_image_uploaded",{detail:e});document.dispatchEvent(a)}else alert(e.message)})}function createMessage(t){$("#message-message").html(t),$(".dim").show(),$("#message").fadeIn()}function validatePost(){return""!=$("#post-title").val()||(createMessage("Your post needs a title."),!1)}function load(t){switch(t){case"start":$(".dim").show(),$(".loading").show();break;case"stop":$(".dim").hide(),$(".loading").hide()}}function getPostId(){return $("#postid-hidden").text()}function initEditor(){$("#italic").on("click",function(){document.execCommand("italic")}),$("#bold").on("click",function(){document.execCommand("bold")}),$("#underline").on("click",function(){document.execCommand("underline")}),$("#strike").on("click",function(){document.execCommand("strikeThrough")}),$("#left").on("click",function(){document.execCommand("justifyLeft")}),$("#center").on("click",function(){document.execCommand("justifyCenter")}),$("#right").on("click",function(){document.execCommand("justifyRight")}),$("#justify").on("click",function(){document.execCommand("justifyFull")}),$("#pre").on("click",function(){document.execCommand("formatBlock",!1,"PRE")}),$("#paragraph").on("click",function(){document.execCommand("formatBlock",!1,"DIV")}),$("#undo").on("click",function(){document.execCommand("undo")}),$("#redo").on("click",function(){document.execCommand("redo")}),$("#header").on("click",function(){document.execCommand("formatBlock",!1,"H2")}),$("#normal").on("click",function(){document.execCommand("removeFormat")}),$("#show-colors-modal").on("click",function(){$("#colors-modal").css("display","inline-block")}),$(".color-choose").on("click",function(){console.log("stuff is happen");var t=document.getSelection();console.log("selection"+t);var e="rgb("+$(this).data("r")+", "+$(this).data("g")+", "+$(this).data("b")+")";document.execCommand("foreColor",!1,e)}),$("#link").on("click",function(){var t=document.getSelection();if(""!=t){var e="";t.anchorNode.parentNode&&t.anchorNode.parentNode.href&&(e=t.anchorNode.parentNode.href);var a=prompt("Enter the link address",e);null!=a&&(a.includes("http://")||a.includes("https://")||(a="http://"+a),document.execCommand("createLink",!1,a))}}),$("#unlink").on("click",function(){document.execCommand("unlink")}),$("#ol").on("click",function(){document.execCommand("insertOrderedList")}),$("#ul").on("click",function(){document.execCommand("insertUnorderedList")}),$("#image").on("click",function(){$("#img-dialog").attr("data-mode","img"),document.getElementById("img-dialog").showModal()}),$("#image-form").on("submit",function(t){console.log("image form submitted"),t.preventDefault();var e=new FormData(document.getElementById("image-form"));e.append("action",actionUploadImage),uploadImage(e)}),$(".feature-image-tool").on("click",function(){})}function insertImage(t){document.execCommand("insertImage",!1,t)&&$("#content").find("img").each(function(){if(!$(this).hasClass("edit-img")){var t=(new Date).getTime(),e="edit-img"+t;wrapImage($(this),t),attachImageEditor($(this),t),$(this).addClass("edit-img").addClass(e).on("click",function(){}),imgEditorCallbacks()}})}function initImages(){console.log("init images"),$(".edit-img").on("click",function(){$(this).parent().find(".img-editor-bar").css("display","flex")})}function wrapImage(t,e){t.wrap('<div class="inline img-editor-wrap img-editor-wrap'+e+'"></div>').on("click",function(){$(this).parent().find(".img-editor-bar").css("display","flex")})}function attachImageEditor(t,e){t.after("<div class='img-editor-bar flex flex-hor container'><div data-imgwrap='.img-editor-wrap"+e+"' data-imgtarget='.edit-img"+e+"' class='img-editor-group flex flex-hor'><button type='button' class='btn img-small'><i class='fa fa-picture-o' aria-hidden='true'></i></button><button type='button' class='btn img-medium'><i class='fa fa-picture-o' aria-hidden='true'></i></button><button type='button' class='btn img-large'><i class='fa fa-picture-o' aria-hidden='true'></i></button><button type='button' class='btn img-full'><i class='fa fa-arrows-h' aria-hidden='true'></i></button></div><div data-imgwrap='.img-editor-wrap"+e+"' data-imgtarget='.edit-img"+e+"' class='img-editor-group flex flex-hor'><button class='btn img-left'>"+iconLeftJustify+"</button><button class='btn img-center'>"+iconCenterJustify+"</button><button class='btn img-right'>"+iconRightJustify+"</button></div><div data-imgwrap='.img-editor-wrap"+e+"' data-imgtarget='.edit-img"+e+"' class='img-editor-group flex flex-hor'><button class='btn img-remove'>"+iconRemove+"</button><button class='btn img-close'>"+iconClose+"</button></div></div>")}function imgEditorCallbacks(){function t(t){return $(t.parent().data("imgwrap"))}$(".img-small").on("click",function(){$($(this).parent().data("imgwrap")).css("width","40%")}),$(".img-medium").on("click",function(){$($(this).parent().data("imgwrap")).css("width","60%")}),$(".img-large").on("click",function(){$($(this).parent().data("imgwrap")).css("width","80%")}),$(".img-full").on("click",function(){$($(this).parent().data("imgwrap")).css("width","100%")}),$(".img-left").on("click",function(){$($(this).parent().data("imgwrap")).css({float:"left",display:"inline-block"})}),$(".img-center").on("click",function(){$($(this).parent().data("imgwrap")).css({float:"none",margin:"auto",display:"block"})}),$(".img-right").on("click",function(){t($(this)).css({float:"right",display:"inline-block"})}),$(".img-remove").on("click",function(){confirm("Are you sure you want to remove this image?")&&t($(this)).remove()}),$(".img-close").on("click",function(){var t;(t=$(this),t.parent().parent()).fadeOut()})}$(document).ready(function(){$("#main-container").html("").load(homeUrl+"src/welcome.php",function(){mainContainerCallbacks()}),$(".home-button").on("click",function(){$("#main-container").html("").load(homeUrl+"src/welcome.php",function(){mainContainerCallbacks()})}),$(".new-post").on("click",function(){load("start"),$("#main-container").html("").load(homeUrl+"src/editor.php",function(){load("stop"),editContainerCallbacks()})}),$(".post-edit").on("click",function(){var t=$(this).data("postid");load("start"),$("#main-container").html("").load(homeUrl+"src/editor.php?postid="+t,function(){editContainerCallbacks(),load("stop")})})}),document.addEventListener("featured_image_uploaded",function(t){console.log(t.detail);var e,a=t.detail;$(".featured-image-pop-wrap").remove(),createMessage('Your image "'+a.original_name+"\" is uploaded and saved as this post's featured image!");var o=$("#template-featured-image").html();e=templator.processTemplate(o,a),$(".feature-image-tool").html(e)}),document.addEventListener("image_uploaded",function(t){console.log(t.detail);var e=t.detail;document.getElementById("img-dialog").close(),insertImage(e.img_url)}),document.addEventListener("post_saved",function(t){createMessage("Your post is safe!")},!1),document.addEventListener("draft_status_changed",function(t){t.detail.draft?(createMessage("This post is now a draft and not visible to the public."),$("body").addClass("")):createMessage("Your post is published and visible to the public!")},!1),document.addEventListener("tag_saved",function(t){console.log(t.detail);var e=t.detail;createMessage('New tag "'+e.tag_name+'" created!');var a=document.createElement("div"),o=document.createElement("div");a=$(a),o=$(o),a.addClass("tag-name").addClass("active-tag").data("tagid",e.tag_id).text(e.tag_name).appendTo("#active-tags"),o.addClass("tag-id").text(e.tag_id).appendTo(a)},!1),document.addEventListener("cat_saved",function(t){console.log(t.detail);var e=t.detail;createMessage('New category "'+e.cat_name+'" created!');var a=document.createElement("div"),o=document.createElement("div");a=$(a),o=$(o),a.addClass("tag-name").addClass("active-tag").data("catid",e.cat_id).text(e.cat_name).appendTo("#active-tags"),o.addClass("tag-id").text(e.cat_id).appendTo(a)},!1),document.addEventListener("permalink_changed",function(t){console.log(t.detail);var e=t.detail;createMessage("This post's url is now \""+homeUrl+e.permalink+".")},!1),document.addEventListener("context_changed",function(){changeCatcher.reset()});var Templator=function(){var i=/{{[\w]+}}/g;this.processTemplate=function(t,e){var a;console.log("debug html, data: "),console.log(t),console.log(e);for(var o=t.match(i),n=0;n<o.length;n++)t=e[a=o[n].replace("{{","").replace("}}","")]?t.replace(o[n],e[a]):t.replace(o[n],"");return t}},templator=new Templator;function formatPermalink(t){return t=(t=(t=t.replace(/ /g,"-")).replace(/[+=\[\]{}|\\/<>;:'"\?!,.&^%\$@\(\)\*\&]/g,"")).toLowerCase()}function editPage(){$("div").attr("contenteditable","true"),$("body").on("click","a",function(t){t.preventDefault(),t.stopPropagation()})}name,name;